{% extends "work_base.html" %}

{% load staticfiles %}
{% load i18n %}
{% load bootstrap_tags %}

{% block head_title %}{% trans "Exchange" %}: {{ exchange }}{% endblock %}

{% block extra_head %}

<link rel="stylesheet" href="https://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />
<link rel="stylesheet" href="{% static 'css/chosen.css' %}" />

<style>

div p:last-child {
    margin-bottom: 2px;
}

form[id^='xferForm'] div[id*='_ocp_resource_type_chzn'] {
  float: left;
}
.add-new-type {
  display: table;
  padding-left: 1em;
}

.event {
    margin-left: 2em;
    margin-bottom: 4px;
}
.btn {
    margin-left: 10px;
}
h3, h4 {
    /*color: firebrick;*/
    margin-bottom: 3px;
}
.modal {
    width: 600px;
}
.subsection-label {
    font-weight: bold;
}
.detail-line {
    margin: 0 0 0 2em;
}
li {
    list-style-type: none;
}
.event-label {
    color: #BE6F54;
    font-weight: bold;
    font-style: normal;
}
.hdg {
    font-weight: bold;
    font-size: 1.1em;
    color: #7D1818;
}
.onhand, .indent {
    margin-left: 3em;
}
.unplanned {
    color: 	#7D1818;
}
#id_notes, #id_url {
    width: 328px;
}
.notes {
    padding-right: 2em;
    font-style: italic;
    margin: -5px 0 7px 2em;
}
.total {
    float: right;
    color: #333;
    font-size: 10pt;
    margin-bottom: 0;
    margin-top: 2px;
}
.info {
    float: right;
    margin-left: 5px;
}
.btn-mini {
    margin-top: 1px;
    margin-bottom: 1px;
}
.item-description {
    height: 40px;
    width: 328px;
}
.totals {
    /*border: solid 2px firebrick;
    background-color: oldlace;*/
    margin-bottom: 12px;
  padding-bottom: 12px;
  padding-top: 11px;
    /*padding-left: 1em;*/
}
.total-top {
    font-weight: bold;
    padding-right: 2em;
}
.bold {
    font-weight: bold;
}
.commitment {
    margin-left: 1em;
}

.log-section {
    /*border: solid 1px gainsboro;*/
    background-color: beige;
    /*padding: 4px;*/
  margin-bottom: 8px;
  padding: 5px 15px;
}
.trt {
    /*border: solid 1px gainsboro;
    background-color: lightyellow;
    padding: 4px;
    margin-bottom: 7px;*/
  padding: 5px 15px;
  margin-bottom: 13px;
  /*background-color: #f0f0da;
  border: 1px solid #CACAC6;
  -moz-border-radius: 7px;
  -webkit-border-radius: 7px;
  border-radius: 7px;*/
}
.trtheading {
    color: #666;
    font-style: italic;
    font-size: 1.2em;
}
.ce {
    margin-left: 2em;
}
.modal-hdg {
    font-weight: bold;
    color: green;
    font-size: 1.1em;
}
.chzn-container .chzn-results li {
  padding: 3px 6px 6px;
}
</style>

{% endblock %}

{% block body_class %}exchange{% endblock %}

{% block body_base %}
<div class="container">
    {% include "_messages.html" %}
	<div>
	<legend>
    <span style="/*font-size:90%;*/">
    <a href="{% url 'members_agent' agent_id=context_agent.id %}">{{ context_agent.name }}</a> > <a href="{% url "exchanges_all" agent_id=context_agent.id %}">{% trans "Exchanges" %}</a> >
      {% if exchange %}
         <span style="">{{ exchange }}</span>
      {% else %}
        {% trans "New" %} {{ exchange_type.name }}
      {% endif %}
      <!-- <span style="font-size:85%; color:#555;">for {{ context_agent.name }}</span> -->
    </span>
{% comment %}
        {% if exchange.order %}
            <form
                style="display: inline;"
                id="order"
                action="{% url "order_plan" order_id=exchange.order.id %}"
                method="GET" >
                <button style="display: inline;"  class="btn btn-info" title="Order for this sale" >{% trans 'Go to Order' %}</button>
            </form>
        {% endif %}
{% endcomment %}
        <div class="subnav">
            <!-- <a class="indent" href="{% url "exchanges_all" agent_id=context_agent.id %}">{% trans "All Exchanges" %}</a>
            <a class="indent" href="{% url 'members_agent' agent_id=context_agent.id %}">{% trans "View Project" %}</a> -->
            <a class="indent" href="{% url "your_projects" %}">{% trans "Your Projects" %}</a>
        </div>
	</legend>

	<div class="row-fluid">

        <div class="span4">
            <div class="totals infobox">
                <p><span class="total-top">{% trans "Total transfer value" %}: {{ total_t }} </span></p>
                <p>
                  <span class="total-top">{% trans "Total reciprocal transfer value" %}: {{ total_rect }} </span>
                </p>
            </div>
            <form class="validateMe miniform" id="exchangeForm" method="POST" action="" style="padding-bottom:13px;">
                {% csrf_token %}
                {{ exchange_form|as_bootstrap }}
                {% if agent %}
                    <!-- <div class="form-actions"> -->
                        <input type="submit" name="save" value="{% trans 'Save changes' %}" class="btn btn-primary" />
                    <!-- </div> -->
                    {% if not exchange %}
                        <p>Enter this information, click on Save changes, then you can enter the exchange detail.</p>
                    {% endif %}
                {% endif %}
            </form>

        </div>

        <div class="span8">
          {% if exchange %}
            <div class="trt infobox">
                <h3 class="trtheading">Outgoing Transfers
                <span class="info"> <a href="#" id="xfer-info" data-toggle="popover" data-trigger='hover' title="Transfers" data-placement="left"
                    data-content="Log the planned and actual transfers for this exchange.  The types of transfers are determined by the type of exchange,
                    as defined by your network.">
                    <img src="{% static 'img/information-icon.png' %}" /></a>
                </span>
                </h3>
                {% for slot in slots %}
                    {% if not slot.is_reciprocal %}
                        <div class="log-section infobox2">
                            <h3>
                                {{ slot.name }}
                                {% if agent and exchange %}
                                    <a href="#addCommitModal{{ slot.id }}" role="button" class="btn btn-primary btn-mini" data-toggle="modal" title="Log a new commitment or plan for a transfer" >
                                        {% trans "New Commitment" %}
                                    </a>
                                    <a href="#addTransferModal{{ slot.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal" title="Log a new transfer without a commitment or plan" >
                                        {% trans "New Transfer" %}
                                    </a>
                                {% endif %}
                                <span class="total">Total: {{ slot.total }}</span>
                            </h3>
                            {% if agent and exchange %}
                                <div class="modal hide fade" id="addTransferModal{{ slot.id }}" tabindex="-1" role="dialog" aria-labelledby="xfer{{ slot.id }}" aria-hidden="true">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                        <h3 id="xfer{{ slot.id }}">{% trans "Log a new " %}{{ slot.name }}</h3>
                                    </div>
                                    <div class="modal-body">
                                        <form class="validateMe" id="xferForm{{ slot.id }}" enctype="multipart/form-data" action="{% url "add_transfer" exchange_id=exchange.id transfer_type_id=slot.id %}" method="POST" >
                                            {% csrf_token %}
                                            {% with slot.add_xfer_form as ax_form %}
                                            Event date:<br />{{ ax_form.event_date }}<br />
                                            {% if not slot.give_agent_is_context %}Transferred from:<br />{{ ax_form.from_agent }}<br />{% endif %}
                                            {% if not slot.receive_agent_is_context %}Transferred to:<br />{{ ax_form.to_agent }}<br />{% endif %}
                                            {% if ax_form.ocp_resource_type %}
                                               {% trans "Type of Resource:" %} <!-- <i>{{ ax_form.ocp_resource_type.label }}</i> --><br />{{ ax_form.ocp_resource_type }}
                                          <!-- <div class='add-new-type'>{{ add_type }}<a href='#' class='btn disabled btn-mini'>{% trans "New Resource Type" %}</a></div> -->
                                          <br />
                                            {% else %}
                                               <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />

                                                Resource type transferred:<br />{{ ax_form.resource_type }}<br />
                                            {% endif %}
                                            Quantity transferred:<br />{{ ax_form.quantity }}<br />
                                            {% if slot.is_currency and xfer.transfer_type.exchange_type.use_case.identifier == "intrnl_xfer" %}
                                                Account from (if virtual account)<br />{{ ax_form.from_resource }}<br />
                                                Account to (if virtual account)<br />{{ ax_form.resource }}<br />
                                            {% else %}
                                                Resource transferred (no entry if not inventoried)<br />{{ ax_form.resource }}<br />
                                            {% endif %}
                                            Description:<br />{{ ax_form.description }}<br />
                                            {% if not slot.is_currency %}
                                                Value (total, not per unit):<br />{{ ax_form.value }}<br />
                                                Unit of value:<br />{{ ax_form.unit_of_value }}<br />
                                            {% endif %}
                                            {% if slot.is_contribution %}Can be a rewarded in a value equation:<br />{{ ax_form.is_contribution }}<br />{% endif %}
                                            {% if slot.is_to_distribute %}Can be distributed in a value equation:<br />{{ ax_form.is_to_distribute }}<br />{% endif %}
                                            {% if slot.is_currency %}Event reference:<br />{{ ax_form.event_reference }}<br />{% endif %}
                                            {% if slot.can_create_resource %}
                                                <br />
                                                <h4>Incoming resource:</h4>
                                                <p>Add to an existing resource:<br />{{ ax_form.resource }}
                                                <br />OR <b>create a new resource</b>:</p>
                                                Identifier: (for example, lot number or serial number)<br />{{ ax_form.identifier }}<br />
                                                URL:<br />{{ ax_form.url }}<br />
                                                Photo URL:<br />{{ ax_form.photo_url }}<br />
                                                Current Resource Location:<br />{{ ax_form.current_location }}<br />
                                                Resource Notes:<br />{{ ax_form.notes }}<br />
                                                Resource Access Rules:<br />{{ ax_form.access_rules }}<br />
                                                {{ slot.create_role_formset.management_form }}
                                                <table>
                                                    <tr>
                                                        <td>{% trans "Resource access role" %}</td>
                                                        <td>{% trans "Assignment" %}</td>
                                                        <td>{% trans "Is contact" %} &nbsp;</td>
                                                    </tr>
                                                    {% for form in slot.create_role_formset %}
                                                        {{ form.id }}
                                                        <tr class="role-row">
                                                            <td class="td-role">{{ form.role }}</td>
                                                            <td class="td-agent">{{ form.agent }}</td>
                                                            <td class="text-center">{{ form.is_contact }}</td>
                                                        </tr>
                                                    {% endfor %}
                                                </table>
                                            {% endif %}
                                            {% endwith %}
                                            <input type="hidden" id="next" name="next" value="exchange-work" />
                                            <div class="modal-footer">
                                                <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                <input type="submit" class="btn btn-primary" name="submit" value="{% trans 'Save' %}" />
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <div class="modal hide fade" id="addCommitModal{{ slot.id }}" tabindex="-1" role="dialog" aria-labelledby="commit" aria-hidden="true">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                        <h3 id="commit">{% trans "Log a new Commitment:" %} {{ slot.name }}</h3>
                                    </div>
                                    <div class="modal-body">
                                        <form class="validateMe" id="commitForm" enctype="multipart/form-data" action="{% url "add_transfer_commitment" exchange_id=exchange.id transfer_type_id=slot.id %}" method="POST" >
                                            {% csrf_token %}
                                            {% with slot.add_commit_form as ac_form %}
                                            Commitment date:<br />{{ ac_form.commitment_date }}<br />
                                            Due date:<br />{{ ac_form.due_date }}<br />
                                            {% if not slot.give_agent_is_context %}Transfer from:<br />{{ ac_form.from_agent }}<br />{% endif %}
                                            {% if not slot.receive_agent_is_context %}Transfer to:<br />{{ ac_form.to_agent }}<br />{% endif %}
                                            Quantity:<br />{{ ac_form.quantity }}<br />
                                            {% if ac_form.ocp_resource_type %}
                                               {% trans "Type of Resource:" %} <!-- <i>{{ ac_form.ocp_resource_type.label }}</i> --> <br />{{ ac_form.ocp_resource_type }}<br />
                                            {% else %}
                                               <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />
                                                Resource type:<br />{{ ac_form.resource_type }}<br />
                                            {% endif %}
                                            Description:<br />{{ ac_form.description }}<br />
                                            {% if not slot.is_currency %}
                                                Value (total, not per unit):<br />{{ ac_form.value }}<br />
                                                Unit of value:<br />{{ ac_form.unit_of_value }}<br />
                                            {% endif %}
                                            {% endwith %}
                                            <input type="hidden" id="next" name="next" value="exchange-work" />
                                            <div class="modal-footer">
                                                <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                <input type="submit" class="btn btn-primary" name="submit" value="{% trans 'Save' %}" />
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            {% endif %}

                            {% for xfer in slot.xfers %}
                                <div class="event">
                                    {% if xfer.commitments.all %}
                                        <span class="event-label">{% trans "Commitment" %}: </span>
                                        {{ xfer.commit_text }}
                                        {% if logger or xfer.commitments.first.created_by == request.user or xfer.commitments.first.to_agent == request.user.agent.agent or xfer.commitments.first.to_agent in request.user.agent.agent.managed_projects %}
                                            <a href="#cmitModal{{ xfer.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal">
                                                <i class="icon-edit"></i>
                                            </a>
                                            <div class="modal hide fade" id="cmitModal{{ xfer.id }}" tabindex="-1" role="dialog" aria-labelledby="cmit-label" aria-hidden="true">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                    <h3 id="cmit-label">{% trans "Change Transfer Commitment" %}</h3>
                                                </div>
                                                <div class="modal-body">
                                                    <form class="validateMe" enctype="multipart/form-data" action="{% url "change_transfer_commitments" transfer_id=xfer.id %}" method="POST" >
                                                        {% if xfer.commitments.first.created_by == request.user %}<div style="float:right">
                                                        {% trans "...created by you" %}</div>{% endif %}
                                                        {% csrf_token %}
                                                        {% with xfer.change_commitments_context_form as cc_form %}
                                                        Commitment date:<br />{{ cc_form.commitment_date }}<br />
                                                        Due date:<br />{{ cc_form.due_date }}<br />
                                                        {% if not slot.give_agent_is_context %}Transfer from:<br />{{ cc_form.from_agent }}<br />{% endif %}
                                                        {% if not slot.receive_agent_is_context %}Transfer to:<br />{{ cc_form.to_agent }}<br />{% endif %}
                                                        Quantity:<br />{{ cc_form.quantity }}<br />
                                                        {% if cc_form.ocp_resource_type %}
                                                          {% trans "Type of Resource:" %} <i>{{ cc_form.ocp_resource_type.label }}</i><br />
                                                          {{ cc_form.ocp_resource_type }}<br />
                                                        {% else %}
                                                          <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />

                                                          Resource type:<br />{{ cc_form.resource_type }}<br />
                                                        {% endif %}
                                                        Description:<br />{{ cc_form.description }}<br />
                                                        {% if not slot.is_currency %}
                                                            Value (total, not per unit):<br />{{ cc_form.value }}<br />
                                                            Unit of value:<br />{{ cc_form.unit_of_value }}<br />
                                                        {% endif %}
                                                        {% endwith %}
                                                        <input type="hidden" id="next" name="next" value="exchange-work" />
                                                        <div class="modal-footer">
                                                            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                            <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                            {% if not xfer.events.all %}
                                                <form
                                                    style="display: inline;"
                                                    class="delete-form"
                                                    id="deleteForm{{ xfer.id }}"
                                                    action="{% url "delete_transfer_commitments" transfer_id=xfer.id %}"
                                                    method="POST" >
                                                    {% csrf_token %}
                                                    <input type="hidden" id="next" name="next" value="exchange-work" />
                                                    <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete transfer" >X</button>
                                                </form>
                                                <a href="#xferModal{{ xfer.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal" alt="Record transfer based on commitment">{% trans "Transfer This" %}</a>
                                                <div class="modal hide fade" id="xferModal{{ xfer.id }}" tabindex="-1" role="dialog" aria-labelledby="xfer-label" aria-hidden="true">
                                                    <div class="modal-header">
                                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                        <h3 id="xfer-label">{% trans "Make Transfer from Commitment" %}</h3>
                                                    </div>
                                                    <div class="modal-body">
                                                        <form class="validateMe" enctype="multipart/form-data" action="{% url "transfer_from_commitment" transfer_id=xfer.id %}" method="POST" >
                                                            {% csrf_token %}
                                                            {% with xfer.commit_transfer_context_form as ct_form %}
                                                            Event date:<br />{{ ct_form.event_date }}<br />
                                                            {% if not slot.give_agent_is_context %}Transferred from:<br />{{ ct_form.from_agent }}<br />{% endif %}
                                                            {% if not slot.receive_agent_is_context %}Transferred to:<br />{{ ct_form.to_agent }}<br />{% endif %}
                                                            Quantity transferred:<br />{{ ct_form.quantity }}<br />
                                                            {% if ct_form.ocp_resource_type %}
                                                              {% trans "Type of Resource transferred:" %} <i>{{ ct_form.ocp_resource_type.label }}</i><br />
                                                              {{ ct_form.ocp_resource_type }}<br />
                                                            {% else %}
                                                              <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />
                                                              Resource type transferred:<br />{{ ct_form.resource_type }}<br />
                                                            {% endif %}
                                                            {% if slot.is_currency and xfer.transfer_type.exchange_type.use_case.identifier == "intrnl_xfer" %}
                                                                Account from (if virtual account)<br />{{ ct_form.from_resource }}<br />
                                                                Account to (if virtual account)<br />{{ ct_form.resource }}<br />
                                                            {% else %}
                                                                Resource transferred (no entry if not inventoried)<br />{{ ct_form.resource }}<br />
                                                            {% endif %}
                                                            Description:<br />{{ ct_form.description }}<br />
                                                            {% if not slot.is_currency %}
                                                                Value (total, not per unit):<br />{{ ct_form.value }}<br />
                                                                Unit of value:<br />{{ ct_form.unit_of_value }}<br />
                                                            {% endif %}
                                                            {% if slot.is_contribution %}Can be a rewarded in a value equation:<br />{{ ct_form.is_contribution }}<br />{% endif %}
                                                            {% if slot.is_to_distribute %}Can be distributed in a value equation:<br />{{ ct_form.is_to_distribute }}<br />{% endif %}
                                                            {% if slot.is_currency %}Event reference:<br />{{ ct_form.event_reference }}<br />{% endif %}
                                                            {% if slot.can_create_resource %}
                                                                <br />
                                                                <h4>Incoming resource:</h4>
                                                                Add to an existing resource:<br />{{ ct_form.resource }}<br />
                                                                <br /><b>OR create a new resource:</b><br />
                                                                Identifier: (for example, lot number or serial number)<br />{{ ct_form.identifier }}<br />
                                                                URL:<br />{{ ct_form.url }}<br />
                                                                Photo URL:<br />{{ ct_form.photo_url }}<br />
                                                                Current Resource Location:<br />{{ ct_form.current_location }}<br />
                                                                Resource Notes:<br />{{ ct_form.notes }}<br />
                                                                Resource Access Rules:<br />{{ ct_form.access_rules }}<br />
                                                                {{ xfer.create_role_formset.management_form }}
                                                                Resource access roles<br />
                                                                {% for form in xfer.create_role_formset %}
                                                                    <tr>
                                                                        <td>{{ form.role }}</td>
                                                                        <td>{{ form.agent }}</td>
                                                                        <td>{{ form.is_contact }} Is contact</td>
                                                                    </tr>
                                                                {% endfor %}
                                                            {% endif %}
                                                            {% endwith %}
                                                            <input type="hidden" id="next" name="next" value="exchange-work" />
                                                            <div class="modal-footer">
                                                                <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                                <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                        {% if xfer.commit_description %}
                                            <div class="notes"> {{ xfer.commit_description|urlize|linebreaks }} </div>
                                        {% endif %}
                                        {% if xfer.events.all %}
                                            <div class="ce">>&nbsp;<span class="event-label">{% trans "Transfer" %}: </span>{{ xfer.commit_event_text }}
                                                {% if logger or xfer.events.first.created_by == request.user or xfer.events.first.to_agent == request.user.agent.agent or xfer.events.first.to_agent in request.user.agent.agent.managed_projects %}
                                                    <a href="#xferModal{{ xfer.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal">
                                                        <i class="icon-edit"></i>
                                                    </a>

                                                    <div class="modal hide fade" id="xferModal{{ xfer.id }}" tabindex="-1" role="dialog" aria-labelledby="xfer-label" aria-hidden="true">
                                                        <div class="modal-header">
                                                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                            <h3 id="xfer-label">{% trans "Change Transfer" %}</h3>
                                                        </div>
                                                        <div class="modal-body">
                                                            <form class="validateMe" enctype="multipart/form-data" action="{% url "change_transfer_events" transfer_id=xfer.id %}" method="POST" >
                                                                {% if xfer.events.first.created_by == request.user %}<div style="float:right">
                                                                {% trans "...created by you" %}</div>{% endif %}

                                                                {% csrf_token %}
                                                                {% with xfer.change_events_context_form as ce_form %}
                                                                Event date:<br />{{ ce_form.event_date }}<br />
                                                                {% if not slot.give_agent_is_context %}Transferred from:<br />{{ ce_form.from_agent }}<br />{% endif %}
                                                                {% if not slot.receive_agent_is_context %}Transferred to:<br />{{ ce_form.to_agent }}<br />{% endif %}
                                                                Quantity transferred:<br />{{ ce_form.quantity }}<br />
                                                                {% if ce_form.ocp_resource_type %}
                                                                  {% trans "Type of Resource:" %} <i>{{ ce_form.ocp_resource_type.label }}</i><br />
                                                                  {{ ce_form.ocp_resource_type }}<br />
                                                                {% else %}
                                                                  <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />
                                                                  Resource type transferred:<br />{{ ce_form.resource_type }}<br />
                                                                {% endif %}
                                                                {% if slot.is_currency and xfer.transfer_type.exchange_type.use_case.identifier == "intrnl_xfer" %}
                                                                    Account from (if virtual account)<br />{{ ce_form.from_resource }}<br />
                                                                    Account to (if virtual account)<br />{{ ce_form.resource }}<br />
                                                                {% else %}
                                                                    Resource transferred (only if inventoried):<br />{{ ce_form.resource }}<br />Description:<br />{{ ce_form.description }}<br />
                                                                {% endif %}
                                                                {% if not slot.is_currency %}
                                                                    Value (total, not per unit):<br />{{ ce_form.value }}<br />
                                                                    Unit of value:<br />{{ ce_form.unit_of_value }}<br />
                                                                {% endif %}
                                                                {% if slot.is_contribution %}Can be rewarded in a value equation:<br />{{ ce_form.is_contribution }}<br />{% endif %}
                                                                {% if slot.is_to_distribute %}Can be distributed in a value equation:<br />{{ ce_form.is_to_distribute }}<br />{% endif %}
                                                                {% if slot.is_currency %}Event reference:<br />{{ ce_form.event_reference }}<br />{% endif %}
                                                                {% endwith %}
                                                                <input type="hidden" id="next" name="next" value="exchange-work" />
                                                                <div class="modal-footer">
                                                                    <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                                    <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                    <form
                                                        style="display: inline;"
                                                        class="delete-form"
                                                        id="deleteForm{{ event.id }}"
                                                        action="{% url "delete_transfer_events" transfer_id=xfer.id %}"
                                                        method="POST" >
                                                        {% csrf_token %}
                                                        <input type="hidden" id="next" name="next" value="exchange-work" />
                                                        <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete transfer" >X</button>
                                                    </form>
                                                {% endif %}
                                                {% if event.description %}
                                                    <div class="notes"> {{ event.description|urlize|linebreaks }} </div>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <span class="event-label">{% trans "Transfer" %}:</span> {{ xfer.event_text }}
                                        {% if logger or xfer.events.first.created_by == request.user or xfer.events.first.to_agent == request.user.agent.agent or xfer.events.first.to_agent in request.user.agent.agent.managed_projects %}
                                            <a href="#xferModal{{ xfer.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal">
                                                <i class="icon-edit"></i>
                                            </a>
                                            <div class="modal hide fade" id="xferModal{{ xfer.id }}" tabindex="-1" role="dialog" aria-labelledby="xfer-label" aria-hidden="true">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                    <h3 id="xfer-label">{% trans "Change Transfer" %}</h3>
                                                </div>
                                                <div class="modal-body">
                                                    <form class="validateMe" enctype="multipart/form-data" action="{% url "change_transfer_events" transfer_id=xfer.id %}" method="POST" >
                                                        {% if xfer.events.first.created_by == request.user %}<div style="float:right">
                                                        {% trans "...created by you" %}</div>{% endif %}

                                                        {% csrf_token %}
                                                        {% with xfer.change_events_context_form as cev_form %}
                                                        Event date:<br />{{ cev_form.event_date }}<br />
                                                        {% if not slot.give_agent_is_context %}Transferred from:<br />{{ cev_form.from_agent }}<br />{% endif %}
                                                        {% if not slot.receive_agent_is_context %}Transferred to:<br />{{ cev_form.to_agent }}<br />{% endif %}
                                                        Quantity transferred:<br />{{ cev_form.quantity }}<br />
                                                        {% if cev_form.ocp_resource_type %}
                                                          {% trans "Type of Resource transferred:" %} <i>{{ cev_form.ocp_resource_type.label }}</i><br />
                                                          {{ cev_form.ocp_resource_type }}<br />
                                                        {% else %}
                                                          <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />
                                                          Resource type transferred:<br />{{ cev_form.resource_type }}<br />
                                                        {% endif %}
                                                        {% if slot.is_currency and xfer.transfer_type.exchange_type.use_case.identifier == "intrnl_xfer" %}
                                                            Account from (if virtual account)<br />{{ cev_form.from_resource }}<br />
                                                            Account to (if virtual account)<br />{{ cev_form.resource }}<br />
                                                        {% else %}
                                                            Resource transferred (only if inventoried):<br />{{ cev_form.resource }}<br />
                                                        {% endif %}
                                                        Description:<br />{{ cev_form.description }}<br />
                                                        {% if not slot.is_currency %}
                                                            Value (total, not per unit):<br />{{ cev_form.value }}<br />
                                                            Unit of value:<br />{{ cev_form.unit_of_value }}<br />
                                                        {% endif %}
                                                        {% if slot.is_contribution %}Can be rewarded in a value equation:<br />{{ cev_form.is_contribution }}<br />{% endif %}
                                                        {% if slot.is_to_distribute %}Can be distributed in a value equation:<br />{{ cev_form.is_to_distribute }}<br />{% endif %}
                                                        {% if slot.is_currency %}Event reference:<br />{{ cev_form.event_reference }}<br />{% endif %}
                                                        {% endwith %}
                                                        <input type="hidden" id="next" name="next" value="exchange-work" />
                                                        <div class="modal-footer">
                                                            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                            <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                            <form
                                                style="display: inline;"
                                                class="delete-form"
                                                id="deleteForm{{ xfer.id }}"
                                                action="{% url "delete_transfer_events" transfer_id=xfer.id %}"
                                                method="POST" >
                                                {% csrf_token %}
                                                <input type="hidden" id="next" name="next" value="exchange-work" />
                                                <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete transfer" >X</button>
                                            </form>
                                        {% endif %}
                                        {% if xfer.event_description %}
                                            <div class="notes"> {{ xfer.event_description|urlize|linebreaks }} </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            {% endfor %}

                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% if exchange.can_have_reciprocal_transfers %}
            <div class="trt infobox">
                <h3 CLASS="trtheading">Incoming Transfers
                <span class="info"> <a href="#" id="rxfer-info" data-toggle="popover" data-trigger='hover' title="Reciprocal Transfers" data-placement="left"
                    data-content="Log the planned and actual reciprocal transfers for this exchange.  The types of reciprocal transfers are determined by the type of exchange,
                    as defined by your network.  They are in return for the primary transfers above.">
                    <img src="{% static 'img/information-icon.png' %}" /></a>
                </span></h3>
                {% for slot in slots %}
                    {% if slot.is_reciprocal %}
                        <div class="log-section infobox2">
                            <h3>
                                {{ slot.name }}
                                {% if agent and exchange %}
                                    <a href="#addCommitModal{{ slot.id }}" role="button" class="btn btn-primary btn-mini" data-toggle="modal" title="Log a new commitment or plan for a transfer" >
                                        {% trans "New Commitment" %}
                                    </a>
                                    <a href="#addTransferModal{{ slot.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal" title="Log a new transfer without a commitment or plan" >
                                        {% trans "New Transfer" %}
                                    </a>
                                {% endif %}
                                <span class="total">Total: {{ slot.total }}</span>
                            </h3>
                            {% if agent and exchange %}
                                <div class="modal hide fade" id="addTransferModal{{ slot.id }}" tabindex="-1" role="dialog" aria-labelledby="xfer{{ slot.id }}" aria-hidden="true">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                        <h3 id="xfer{{ slot.id }}">{% trans "Log a new:" %} {{ slot.name }}</h3>
                                    </div>
                                    <div class="modal-body">
                                        <form class="validateMe" id="xferForm{{ slot.id }}" enctype="multipart/form-data" action="{% url "add_transfer" exchange_id=exchange.id transfer_type_id=slot.id %}" method="POST" >
                                            {% csrf_token %}
                                            {% with slot.add_xfer_form as ax_form %}
                                            Event date:<br />{{ ax_form.event_date }}<br />
                                            {% if not slot.give_agent_is_context %}Transferred from:<br />{{ ax_form.from_agent }}<br />{% endif %}
                                            {% if not slot.receive_agent_is_context %}Transferred to:<br />{{ ax_form.to_agent }}<br />{% endif %}
                                            Quantity transferred:<br />{{ ax_form.quantity }}<br />
                                            {% if ax_form.ocp_resource_type %}
                                              {% trans "Type of Resource:" %} <!--<i>{{ ax_form.ocp_resource_type.label }}</i> --><br />
                                              {{ ax_form.ocp_resource_type }}
                                              <!-- <div class='add-new-type'>{{ add_type }}<a href='#' class='btn disabled btn-mini'>{% trans "New Resource Type" %}</a></div> -->
                                              <br />
                                            {% else %}
                                              <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />
                                              Resource type transferred:<br />{{ ax_form.resource_type }}<br />
                                            {% endif %}
                                            {% if slot.is_currency and xfer.transfer_type.exchange_type.use_case.identifier == "intrnl_xfer" %}
                                                Account from (if virtual account)<br />{{ ax_form.from_resource }}<br />
                                                Account to (if virtual account)<br />{{ ax_form.resource }}<br />
                                            {% else %}
                                                Resource transferred (no entry if not inventoried)<br />{{ ax_form.resource }}<br />
                                            {% endif %}
                                            Description:<br />{{ ax_form.description }}<br />
                                            {% if not slot.is_currency %}
                                                Value (total, not per unit):<br />{{ ax_form.value }}<br />
                                                Unit of value:<br />{{ ax_form.unit_of_value }}<br />
                                            {% endif %}
                                            {% if slot.is_contribution %}Can be a rewarded in a value equation:<br />{{ ax_form.is_contribution }}<br />{% endif %}
                                            {% if slot.is_to_distribute %}Can be distributed in a value equation:<br />{{ ax_form.is_to_distribute }}<br />{% endif %}
                                            {% if slot.is_currency %}Event reference:<br />{{ ax_form.event_reference }}<br />{% endif %}
                                            {% if slot.can_create_resource %}
                                                <br />
                                                <h4>Incoming resource:</h4>
                                                Add to an existing resource:<br />{{ ax_form.resource }}<br />
                                                <br /><b>OR create a new resource:</b><br />
                                                Identifier: (for example, lot number or serial number)<br />{{ ax_form.identifier }}<br />
                                                URL:<br />{{ ax_form.url }}<br />
                                                Photo URL:<br />{{ ax_form.photo_url }}<br />
                                                Current Resource Location:<br />{{ ax_form.current_location }}<br />
                                                Resource Notes:<br />{{ ax_form.notes }}<br />
                                                Resource Access Rules:<br />{{ ax_form.access_rules }}<br />
                                                {{ slot.create_role_formset.management_form }}
                                                <table>
                                                    <tr>
                                                        <td>{% trans "Resource access role" %}</td>
                                                        <td>{% trans "Assignment" %}</td>
                                                        <td>{% trans "Is contact" %} &nbsp;</td>
                                                    </tr>
                                                    {% for form in slot.create_role_formset %}
                                                        {{ form.id }}
                                                        <tr class="role-row">
                                                            <td class="td-role">{{ form.role }}</td>
                                                            <td class="td-agent">{{ form.agent }}</td>
                                                            <td class="text-center">{{ form.is_contact }}</td>
                                                        </tr>
                                                    {% endfor %}
                                                </table>
                                            {% endif %}
                                            {% endwith %}
                                            <input type="hidden" id="next" name="next" value="exchange-work" />
                                            <div class="modal-footer">
                                                <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                <input type="submit" class="btn btn-primary" name="submit" value="{% trans 'Save' %}" />
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <div class="modal hide fade" id="addCommitModal{{ slot.id }}" tabindex="-1" role="dialog" aria-labelledby="commit" aria-hidden="true">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                        <h3 id="commit">{% trans "Log a new Commitment:" %} {{ slot.name }}</h3>
                                    </div>
                                    <div class="modal-body">
                                        <form class="validateMe" id="commitForm" enctype="multipart/form-data" action="{% url "add_transfer_commitment" exchange_id=exchange.id transfer_type_id=slot.id %}" method="POST" >
                                            {% csrf_token %}
                                            {% with slot.add_commit_form as ac_form %}
                                            Commitment date:<br />{{ ac_form.commitment_date }}<br />
                                            Due date:<br />{{ ac_form.due_date }}<br />
                                            {% if not slot.give_agent_is_context %}Transfer from:<br />{{ ac_form.from_agent }}<br />{% endif %}
                                            {% if not slot.receive_agent_is_context %}Transfer to:<br />{{ ac_form.to_agent }}<br />{% endif %}
                                            Quantity:<br />{{ ac_form.quantity }}<br />
                                            {% if ac_form.ocp_resource_type %}
                                              {% trans "Type of Resource:" %} <i>{{ ac_form.ocp_resource_type.label }}</i><br />
                                              {{ ac_form.ocp_resource_type }}<br />
                                            {% else %}
                                              <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />
                                              Resource type:<br />{{ ac_form.resource_type }}<br />
                                            {% endif %}
                                            Description:<br />{{ ac_form.description }}<br />
                                            {% if not slot.is_currency %}
                                                Value (total, not per unit):<br />{{ ac_form.value }}<br />
                                                Unit of value:<br />{{ ac_form.unit_of_value }}<br />
                                            {% endif %}
                                            {% endwith %}
                                            <input type="hidden" id="next" name="next" value="exchange-work" />
                                            <div class="modal-footer">
                                                <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                <input type="submit" class="btn btn-primary" name="submit" value="{% trans 'Save' %}" />
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            {% endif %}

                            {% for xfer in slot.xfers %}
                                <div class="event">
                                    {% if xfer.commitments.all %}
                                        <span class="event-label">{% trans "Commitment" %}: </span>
                                        {{ xfer.commit_text }}
                                        {% if logger or xfer.commitments.first.created_by == request.user or xfer.commitments.first.from_agent == request.user.agent.agent or xfer.commitments.first.from_agent in request.user.agent.agent.managed_projects %}
                                            <a href="#cmitModal{{ xfer.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal">
                                                <i class="icon-edit"></i>
                                            </a>
                                            <div class="modal hide fade" id="cmitModal{{ xfer.id }}" tabindex="-1" role="dialog" aria-labelledby="cmit-label" aria-hidden="true">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                    <h3 id="cmit-label">{% trans "Change Transfer Commitment" %}</h3>
                                                </div>
                                                <div class="modal-body">
                                                    <form class="validateMe" enctype="multipart/form-data" action="{% url "change_transfer_commitments" transfer_id=xfer.id %}" method="POST" >
                                                        {% if xfer.commitments.first.created_by == request.user %}<div style="float:right">
                                                        {% trans "...created by you" %}</div>{% endif %}

                                                        {% csrf_token %}
                                                        {% with xfer.change_commitments_context_form as cc_form %}
                                                        Commitment date:<br />{{ cc_form.commitment_date }}<br />
                                                        Due date:<br />{{ cc_form.due_date }}<br />
                                                        {% if not slot.give_agent_is_context %}Transfer from:<br />{{ cc_form.from_agent }}<br />{% endif %}
                                                        {% if not slot.receive_agent_is_context %}Transfer to:<br />{{ cc_form.to_agent }}<br />{% endif %}
                                                        Quantity:<br />{{ cc_form.quantity }}<br />
                                                        {% if cc_form.ocp_resource_type %}
                                                          {% trans "Type of Resource:" %} <i>{{ cc_form.ocp_resource_type.label }}</i><br />
                                                          {{ cc_form.ocp_resource_type }}<br />
                                                        {% else %}
                                                          <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />

                                                          Resource type:<br />{{ cc_form.resource_type }}<br />
                                                        {% endif %}
                                                        Description:<br />{{ cc_form.description }}<br />
                                                        {% if not slot.is_currency %}
                                                            Value (total, not per unit):<br />{{ cc_form.value }}<br />
                                                            Unit of value:<br />{{ cc_form.unit_of_value }}<br />
                                                        {% endif %}
                                                        {% endwith %}
                                                        <input type="hidden" id="next" name="next" value="exchange-work" />
                                                        <div class="modal-footer">
                                                            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                            <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                            {% if not xfer.events.all %}
                                                <form
                                                    style="display: inline;"
                                                    class="delete-form"
                                                    id="deleteForm{{ xfer.id }}"
                                                    action="{% url "delete_transfer_commitments" transfer_id=xfer.id %}"
                                                    method="POST" >
                                                    {% csrf_token %}
                                                    <input type="hidden" id="next" name="next" value="exchange-work" />
                                                    <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete transfer" >X</button>
                                                </form>
                                                <a href="#xferModal{{ xfer.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal" alt="Record transfer based on commitment">{% trans "Transfer This" %}</a>
                                                <div class="modal hide fade" id="xferModal{{ xfer.id }}" tabindex="-1" role="dialog" aria-labelledby="xfer-label" aria-hidden="true">
                                                    <div class="modal-header">
                                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                        <h3 id="xfer-label">{% trans "Make Transfer from Commitment" %}</h3>
                                                    </div>
                                                    <div class="modal-body">
                                                        <form class="validateMe" enctype="multipart/form-data" action="{% url "transfer_from_commitment" transfer_id=xfer.id %}" method="POST" >
                                                            {% csrf_token %}
                                                            {% with xfer.commit_transfer_context_form as ct_form %}
                                                            Event date:<br />{{ ct_form.event_date }}<br />
                                                            {% if not slot.give_agent_is_context %}Transferred from:<br />{{ ct_form.from_agent }}<br />{% endif %}
                                                            {% if not slot.receive_agent_is_context %}Transferred to:<br />{{ ct_form.to_agent }}<br />{% endif %}
                                                            Quantity transferred:<br />{{ ct_form.quantity }}<br />
                                                            {% if ct_form.ocp_resource_type %}
                                                              {% trans "Type of Resource transferred:" %} <i>{{ ct_form.ocp_resource_type.label }}</i><br />
                                                              {{ ct_form.ocp_resource_type }}<br />
                                                            {% else %}
                                                              <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />
                                                              Resource type transferred:<br />{{ ct_form.resource_type }}<br />
                                                            {% endif %}
                                                            {% if slot.is_currency and xfer.transfer_type.exchange_type.use_case.identifier == "intrnl_xfer" %}
                                                                Account from (if virtual account)<br />{{ ct_form.from_resource }}<br />
                                                                Account to (if virtual account)<br />{{ ct_form.resource }}<br />
                                                            {% else %}
                                                                Resource transferred (no entry if not inventoried)<br />{{ ct_form.resource }}<br />
                                                            {% endif %}
                                                            Description:<br />{{ ct_form.description }}<br />
                                                            {% if not slot.is_currency %}
                                                                Value (total, not per unit):<br />{{ ct_form.value }}<br />
                                                                Unit of value:<br />{{ ct_form.unit_of_value }}<br />
                                                            {% endif %}
                                                            {% if slot.is_contribution %}Can be a rewarded in a value equation:<br />{{ ct_form.is_contribution }}<br />{% endif %}
                                                            {% if slot.is_to_distribute %}Can be distributed in a value equation:<br />{{ ct_form.is_to_distribute }}<br />{% endif %}
                                                            {% if slot.is_currency %}Event reference:<br />{{ ct_form.event_reference }}<br />{% endif %}
                                                            {% if slot.can_create_resource %}
                                                                <br />
                                                                <h4>Incoming resource:</h4>
                                                                Add to an existing resource:<br />{{ ct_form.resource }}<br />
                                                                <br /><b>OR create a new resource:</b><br />
                                                                Identifier: (for example, lot number or serial number)<br />{{ ct_form.identifier }}<br />
                                                                URL:<br />{{ ct_form.url }}<br />
                                                                Photo URL:<br />{{ ct_form.photo_url }}<br />
                                                                Current Resource Location:<br />{{ ct_form.current_location }}<br />
                                                                Resource Notes:<br />{{ ct_form.notes }}<br />
                                                                Resource Access Rules:<br />{{ ct_form.access_rules }}<br />
                                                                {{ xfer.create_role_formset.management_form }}
                                                                Resource access roles<br />
                                                                {% for form in xfer.create_role_formset %}
                                                                    <tr>
                                                                        <td>{{ form.role }}</td>
                                                                        <td>{{ form.agent }}</td>
                                                                        <td>{{ form.is_contact }} Is contact</td>
                                                                    </tr>
                                                                {% endfor %}
                                                            {% endif %}
                                                            {% endwith %}
                                                            <input type="hidden" id="next" name="next" value="exchange-work" />
                                                            <div class="modal-footer">
                                                                <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                                <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        {% endif %}
                                        {% if xfer.commit_description %}
                                            <div class="notes"> {{ xfer.commit_description|urlize|linebreaks }} </div>
                                        {% endif %}
                                        {% if xfer.events.all %}
                                            <div class="ce">>&nbsp;<span class="event-label">{% trans "Transfer" %}: </span>{{ xfer.commit_event_text }}
                                                {% if logger or xfer.events.first.created_by == request.user or xfer.events.first.from_agent == request.user.agent.agent or xfer.events.first.from_agent in request.user.agent.agent.managed_projects %}
                                                    <a href="#xferModal{{ xfer.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal">
                                                        <i class="icon-edit"></i>
                                                    </a>

                                                    <div class="modal hide fade" id="xferModal{{ xfer.id }}" tabindex="-1" role="dialog" aria-labelledby="xfer-label" aria-hidden="true">
                                                        <div class="modal-header">
                                                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                            <h3 id="xfer-label">{% trans "Change Transfer" %}</h3>
                                                        </div>
                                                        <div class="modal-body">
                                                            <form class="validateMe" enctype="multipart/form-data" action="{% url "change_transfer_events" transfer_id=xfer.id %}" method="POST" >
                                                                {% if xfer.events.first.created_by == request.user %}<div style="float:right">
                                                                {% trans "...created by you" %}</div>{% endif %}

                                                                {% csrf_token %}
                                                                {% with xfer.change_events_context_form as ce_form %}
                                                                Event date:<br />{{ ce_form.event_date }}<br />
                                                                {% if not slot.give_agent_is_context %}Transferred from:<br />{{ ce_form.from_agent }}<br />{% endif %}
                                                                {% if not slot.receive_agent_is_context %}Transferred to:<br />{{ ce_form.to_agent }}<br />{% endif %}
                                                                Quantity transferred:<br />{{ ce_form.quantity }}<br />
                                                                {% if ce_form.ocp_resource_type %}
                                                                  {% trans "Type of Resource transferred:" %} <i>{{ ce_form.ocp_resource_type.label }}</i><br />
                                                                  {{ ce_form.ocp_resource_type }}<br />
                                                                {% else %}
                                                                  <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />
                                                                  Resource type transferred:<br />{{ ce_form.resource_type }}<br />
                                                                {% endif %}
                                                                {% if slot.is_currency and xfer.transfer_type.exchange_type.use_case.identifier == "intrnl_xfer" %}
                                                                    Account from (if virtual account)<br />{{ ce_form.from_resource }}<br />
                                                                    Account to (if virtual account)<br />{{ ce_form.resource }}<br />
                                                                {% else %}
                                                                    Resource transferred (only if inventoried):<br />{{ ce_form.resource }}<br />
                                                                {% endif %}
                                                                Description:<br />{{ ce_form.description }}<br />
                                                                {% if not slot.is_currency %}
                                                                    Value (total, not per unit):<br />{{ ce_form.value }}<br />
                                                                    Unit of value:<br />{{ ce_form.unit_of_value }}<br />
                                                                {% endif %}
                                                                {% if slot.is_contribution %}Can be rewarded in a value equation:<br />{{ ce_form.is_contribution }}<br />{% endif %}
                                                                {% if slot.is_to_distribute %}Can be distributed in a value equation:<br />{{ ce_form.is_to_distribute }}<br />{% endif %}
                                                                {% if slot.is_currency %}Event reference:<br />{{ ce_form.event_reference }}<br />{% endif %}
                                                                {% endwith %}
                                                                <input type="hidden" id="next" name="next" value="exchange-work" />
                                                                <div class="modal-footer">
                                                                    <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                                    <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                    <form
                                                        style="display: inline;"
                                                        class="delete-form"
                                                        id="deleteForm{{ event.id }}"
                                                        action="{% url "delete_transfer_events" transfer_id=xfer.id %}"
                                                        method="POST" >
                                                        {% csrf_token %}
                                                        <input type="hidden" id="next" name="next" value="exchange-work" />
                                                        <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete transfer" >X</button>
                                                    </form>
                                                {% endif %}
                                                {% if event.description %}
                                                    <div class="notes"> {{ event.description|urlize|linebreaks }} </div>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <span class="event-label">{% trans "Transfer" %}: </span>{{ xfer.event_text }}
                                        {% if logger or xfer.events.first.created_by == request.user or xfer.events.first.from_agent == request.user.agent.agent or xfer.events.first.from_agent in request.user.agent.agent.managed_projects  %}
                                            <a href="#xferModal{{ xfer.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal">
                                                <i class="icon-edit"></i>
                                            </a>
                                            <div class="modal hide fade" id="xferModal{{ xfer.id }}" tabindex="-1" role="dialog" aria-labelledby="xfer-label" aria-hidden="true">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                    <h3 id="xfer-label">{% trans "Change Transfer" %}</h3>
                                                </div>
                                                <div class="modal-body">
                                                    <form class="validateMe" enctype="multipart/form-data" action="{% url "change_transfer_events" transfer_id=xfer.id %}" method="POST" >
                                                        {% if xfer.events.first.created_by == request.user %}<div style="float:right">
                                                        {% trans "...created by you" %}</div>{% endif %}

                                                        {% csrf_token %}
                                                        {% with xfer.change_events_context_form as cev_form %}
                                                        Event date:<br />{{ cev_form.event_date }}<br />
                                                        {% if not slot.give_agent_is_context %}Transferred from:<br />{{ cev_form.from_agent }}<br />{% endif %}
                                                        {% if not slot.receive_agent_is_context %}Transferred to:<br />{{ cev_form.to_agent }}<br />{% endif %}
                                                        Quantity transferred:<br />{{ cev_form.quantity }}<br />
                                                        {% if cev_form.ocp_resource_type %}
                                                          {% trans "Type of Resource transferred:" %} <i>{{ cev_form.ocp_resource_type.label }}</i><br />
                                                          {{ cev_form.ocp_resource_type }}<br />
                                                        {% else %}
                                                          <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />
                                                          Resource type transferred:<br />{{ cev_form.resource_type }}<br />
                                                        {% endif %}
                                                        {% if slot.is_currency and xfer.transfer_type.exchange_type.use_case.identifier == "intrnl_xfer" %}
                                                            Account from (if virtual account)<br />{{ cev_form.from_resource }}<br />
                                                            Account to (if virtual account)<br />{{ cev_form.resource }}<br />
                                                        {% else %}
                                                            Resource transferred (only if inventoried):<br />{{ cev_form.resource }}<br />Description:<br />{{ xfer.change_events_context_form.description }}<br />
                                                        {% endif %}
                                                        {% if not slot.is_currency %}
                                                            Value (total, not per unit):<br />{{ cev_form.value }}<br />
                                                            Unit of value:<br />{{ cev_form.unit_of_value }}<br />
                                                        {% endif %}
                                                        {% if slot.is_contribution %}Can be rewarded in a value equation:<br />{{ cev_form.is_contribution }}<br />{% endif %}
                                                        {% if slot.is_to_distribute %}Can be distributed in a value equation:<br />{{ cev_form.is_to_distribute }}<br />{% endif %}
                                                        {% if slot.is_currency %}Event reference:<br />{{ cev_form.event_reference }}<br />{% endif %}
                                                        {% endwith %}
                                                        <input type="hidden" id="next" name="next" value="exchange-work" />
                                                        <div class="modal-footer">
                                                            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                            <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                            <form
                                                style="display: inline;"
                                                class="delete-form"
                                                id="deleteForm{{ xfer.id }}"
                                                action="{% url "delete_transfer_events" transfer_id=xfer.id %}"
                                                method="POST" >
                                                {% csrf_token %}
                                                <input type="hidden" id="next" name="next" value="exchange-work" />
                                                <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete transfer" >X</button>
                                            </form>
                                        {% endif %}
                                        {% if xfer.event_description %}
                                            <div class="notes"> {{ xfer.event_description|urlize|linebreaks }} </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            {% endfor %}

                        </div>
                    {% endif %}

                {% endfor %}
            </div>
            {% endif %}

            <div class="log-section infobox2">
                <h3 style="margin-bottom: 4px;" >
                    {% trans "Work" %}
                    {% if logger and exchange %}
                        <a href="#addWorkModal" role="button" class="btn btn-info btn-mini" data-toggle="modal" title="Add work done for this exchange.">
                            {% trans "Log a work event" %}
                        </a>
                    {% endif %}
                    <span class="info"> <a href="#" id="work-info" data-toggle="popover" data-trigger='hover' title="Work Events"
                        data-content="Enter the time you spent on this exchange. This might be preparing paperwork,
                        communicating, traveling, even logging the exchange." data-placement="left">
                        <img src="{% static 'img/information-icon.png' %}" /></a>
                    </span>
                </h3>
                {% if logger and exchange %}
                    <div class="modal hide fade" id="addWorkModal" tabindex="-1" role="dialog" aria-labelledby="work-label" aria-hidden="true">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                            <h3 id="work-label">{% trans "Add Work Done for This Exchange" %}</h3>
                        </div>
                        <div class="modal-body">
                            <form class="validateMe" id="workForm" enctype="multipart/form-data" action="{% url "add_work_for_exchange" exchange_id=exchange.id %}" method="POST" >
                                <input type="hidden" id="next" name="next" value="exchange-work" />
                                {% csrf_token %}
                                <label>{{ add_work_form.event_date.label }}:</label> {{ add_work_form.event_date }}
                                {% if add_work_form.event_date.help_text %}<br/><span class="helptext">{{ add_work_form.event_date.help_text }}</span>{% endif %}
                                <label>{{ add_work_form.ocp_skill_type.label }}:</label> {{ add_work_form.ocp_skill_type }}
                                {% if add_work_form.ocp_skill_type.help_text %}<br/><span class="helptext">{{ add_work_form.ocp_skill_type.help_text }}</span>{% endif %}
                                <label>{{ add_work_form.from_agent.label }}:</label> {{ add_work_form.from_agent }}
                                {% if add_work_form.from_agent.help_text %}<br/><span class="helptext">{{ add_work_form.from_agent.help_text }}</span>{% endif %}
                                <label>{{ add_work_form.quantity.label }}:</label> {{ add_work_form.quantity }}
                                {% if add_work_form.quantity.help_text %}<br/><span class="helptext">{{ add_work_form.quantity.help_text }}</span>{% endif %}
                                <label>{{ add_work_form.is_contribution.label }}:</label> {{ add_work_form.is_contribution }}
                                {% if add_work_form.is_contribution.help_text %}<br/><span class="helptext">{{ add_work_form.is_contribution.help_text }}</span>{% endif %}
                                <label>{{ add_work_form.description.label }}:</label> {{ add_work_form.description }}
                                {% if add_work_form.description.help_text %}<br/><span class="helptext">{{ add_work_form.description.help_text }}</span>{% endif %}
                                <div class="modal-footer">
                                    <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                    <input type="submit" class="btn btn-primary" name="submit" value="{% trans 'Save' %}" />
                                </div>
                            </form>
                        </div>
                    </div>
                {% endif %}

                {% for event in work_events %}
                    <div class="event" >
                        <span ><span class="event-label">{% trans "Work event" %}: </span><b> {{ event.resource_type.name }}</b> {{ event.quantity }} {{ event.unit_of_quantity }} {{ event.event_date }} <span class="taken">{% trans "Done by" %} {{ event.from_agent.nick }}</span></span>
                        {% if agent == event.from_agent or logger or event.created_by == request.user %}

                            <a href="#eventModal{{ event.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal">
                                <i class="icon-edit"></i>
                            </a>

                            <div class="modal hide fade" id="eventModal{{ event.id }}" tabindex="-1" role="dialog" aria-labelledby="event-label" aria-hidden="true">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                    <h3 id="event-label">{% trans "Change Time Contribution" %}</h3>
                                </div>
                                <div class="modal-body">
                                    <form class="validateMe"  class="eventForm{{ event.id }} validateMe" enctype="multipart/form-data" action="{% url "change_exchange_work_event" event_id=event.id %}" method="POST" >
                                        {% csrf_token %}
                                        {% with event.changeform as form %}
                                          <label>{{ form.event_date.label }}:</label> {{ form.event_date }}
                                          {% if form.event_date.help_text %}<br/><span class="helptext">{{ form.event_date.help_text }}</span>{% endif %}
                                          <label>{{ form.ocp_skill_type.label }}:</label> {{ form.ocp_skill_type }}
                                          {% if form.ocp_skill_type.help_text %}<br/><span class="helptext">{{ form.ocp_skill_type.help_text }}</span>{% endif %}
                                          <label>{{ form.from_agent.label }}:</label> {{ form.from_agent }}
                                          {% if form.from_agent.help_text %}<br/><span class="helptext">{{ form.from_agent.help_text }}</span>{% endif %}
                                          <label>{{ form.quantity.label }}:</label> {{ form.quantity }}
                                          {% if form.quantity.help_text %}<br/><span class="helptext">{{ form.quantity.help_text }}</span>{% endif %}
                                          <label>{{ form.is_contribution.label }}:</label> {{ form.is_contribution }}
                                          {% if form.is_contribution.help_text %}<br/><span class="helptext">{{ form.is_contribution.help_text }}</span>{% endif %}
                                          <label>{{ form.description.label }}:</label> {{ form.description }}
                                        {% if form.description.help_text %}<br/><span class="helptext">{{ form.description.help_text }}</span>{% endif %}
                                        {% endwith %}

                                        <input type="hidden" id="next" name="next" value="exchange-work" />
                                        <div class="modal-footer">
                                            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                            <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <form
                                style="display: inline;"
                                class="delete-form"
                                id="deleteForm{{ event.id }}"
                                action="{% url "delete_event" event_id=event.id %}"
                                method="POST" >
                                {% csrf_token %}
                                <input type="hidden" id="next" name="next" value="exchange-work" />
                                <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete work contribution!" >X</button>
                            </form>
                        {% endif %}
                        {% if event.description %}
                        <div class="notes"> {{ event.description|urlize|linebreaks }} </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
          {% endif %}
        </div>
    </div>
</div>

{% endblock %}
{% block extra_script %}
	<script src="https://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
	<script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jquery.validate/1.10.0/jquery.validate.min.js"></script>
	<script src="{% static 'js/chosen.jquery.js' %}"></script>
{% endblock %}

{% block extra_body %}
	{{ block.super }}

    <script type="text/javascript">

	$(document).ready(function(){
      /*var ObjChosSingle = {
        allow_single_deselect: true,
        width: "250px",
        //no_results_text: "Oops, nothing found!",
        disable_search_threshold: 6
      };*/

		  $(".chzn-select").chosen();// ObjChosSingle );

      //$(".chzn-results").menu();

		  $('.date-entry').datepicker({ dateFormat: "yy-mm-dd" });

      $('#work-info').popover();
      $('#xfer-info').popover();
      $('#rxfer-info').popover();

		  jQuery.validator.addMethod("quantity",
            function(value, element) {
                var isValidQuantity = /^\d{0,6}(\.\d{0,2})?$/.test(value);
                return this.optional(element) || isValidQuantity;
            },
            "Please enter a number less than 1000000 with no more than 2 decimal places"
        );

        jQuery.validator.setDefaults({
            success: function(label) {
		        label
			        .text('').addClass('valid')
			        .closest('.control-group').addClass('success');
	        }
        });

        $.validator.addClassRules("quantity", { required: true, quantity: true, });
        //$.validator.addClassRules("value", { required: true, number: true });
		    $.validator.addClassRules("url", { url: true });
        $.validator.addClassRules("resourceType", { required: true});
        $.validator.addClassRules("hours", {
			  required: true,
			  number: true,
			  min: 0,
			  max: 24
		});
		$.validator.addClassRules("minutes", {
			  required: true,
			  number: true,
			  min: 0,
			  max: 60
		});
    $.validator.addClassRules("date-entry", { required: true, date: true });

    $.validator.addMethod("agentRequired", function (value, element) {
            var form_id = element.form.id;
            form_id = "#" + form_id;
            var parent = element.parentElement;
            var parentSib = parent.nextElementSibling;
            var sib = parentSib.children[0];
            var sibValue = sib.value;
            if (sibValue){
                var sibId = sib.id;
                sibId = "#" + sibId;
                $(sibId).removeClass('error').next('label.error').remove();
            }
            return this.optional(element) || sibValue;
        }, "Both role and agent must be selected.");

    $.validator.addMethod("roleRequired", function (value, element) {
            var form_id = element.form.id;
            form_id = "#" + form_id;
            var parent = element.parentElement;
            var parentSib = parent.previousElementSibling;
            var sib = parentSib.children[0];
            var sibValue = sib.value;
            if (sibValue){
                var sibId = sib.id;
                sibId = "#" + sibId;
                $(sibId).removeClass('error').next('label.error').remove();
            }
            return this.optional(element) || sibValue;
        }, "Both role and agent must be selected.");

    $.validator.addClassRules("select-role", { agentRequired: true });
    $.validator.addClassRules("select-agent", { roleRequired: true });

    $('.validateMe').each( function(){
			var form = $(this);
			form.validate({
				highlight: function(label) {
					$(label).closest('.control-group').addClass('error');
				}
			});
		});

    $("#btnAddReceipt").click(setReceiptModal);
    $("#btnAddMaterial").click(setMaterialModal);

    function setReceiptModal() {
      var targetId = "id_unorderedreceipt-resource_type";
      var resourceTypeId = $("#id_unorderedreceipt-resource_type").val()
      //alert("onload rtid " + resourceTypeId);
      JsonSetUnitAndRule(resourceTypeId, targetId);
    };

    function setMaterialModal() {
      var targetId = "id_material-resource_type";
      var resourceTypeId = $("#id_material-resource_type").val()
      //alert("onload rtid " + resourceTypeId);
      JsonSetUnitAndRule(resourceTypeId, targetId);
    };

	  $(".resource-type-selector").change(getUnitAndRule);

		function getUnitAndRule(event) {
	      $(".chzn-select").trigger("liszt:updated");
		    var resourceTypeId = event.target.value;
            //alert("rt " + resourceTypeId);
		    if (resourceTypeId) {
                var targetId = event.target.id;
                //alert("targetId " + targetId);
                JsonSetUnitAndRule(resourceTypeId, targetId);
		    }
	   }

	   $(".resource-type-for-resource").change(getResources);

     function getResources(event) {
            var resourceTypeId = event.target.value;
            if (resourceTypeId)
            {
                var targetId = event.target.id;
                var prefix = targetId.split('-')[0];
                var resourceFieldId = "#" + prefix + "-resource";
                $(resourceFieldId).empty();
                var jsonUrl = encodeURI("/accounting/json-resourcetype-resources-locations/" + resourceTypeId + "/");
                $.get(jsonUrl,
                    function(data){
                    $(resourceFieldId).append('<option value="">' + '--------' + '</option>');
                    for(var i=0 ; i<data.length ; i++)
                    {
                        var id = data[i].fields['pk'];
                        var name = data[i].fields['identifier'];
                        var loc = data[i].fields['location'];
                        if (loc){
                            name = name + " at " + loc;
                        }
                        $(resourceFieldId).append('<option value="' + id + '">' + name + '</option>')
                    }
                    $(".chzn-select").trigger("liszt:updated");
                });
            }
      }


      if($( '#use-case' ).val() == 'res_contr' || $( '#use-case' ).val() == 'cash_contr') {
            $( '#div_id_supplier' ).hide();
      } else {
            $( '#div_id_supplier' ).show();
      }

      /*$('#receiptForm').click(function (event) {
            var isValid = $("#receiptForm").validate();
            if (!isValid) {
                event.preventDefault();
            }
      });

      $('#paymentForm').click(function (event) {
            var isValid = $("#paymentForm").validate();
            if (!isValid) {
                event.preventDefault();
            }
      });

      $('#expenseForm').click(function (event) {
            var isValid = $("#expenseForm").validate();
            if (!isValid) {
                event.preventDefault();
            }
      });*/

      $('#workForm').click(function (event) {
        var isValid = $("#workForm").validate();
        if (!isValid) {
          event.preventDefault();
        }
      });

      /*$('#cashForm').click(function (event) {
            var isValid = $("#cashForm").validate();
            if (!isValid) {
                event.preventDefault();
            }
      });

      $('#materialForm').click(function (event) {
            var isValid = $("#materialForm").validate();
            if (!isValid) {
                event.preventDefault();
            }
      });*/

		  $( "#help" ).toggle( function(){
            $('#help-content').show("slide", { direction: "right" }, "slow" );
            $( "#help" ).text("Hide Help");
      }, function() {
            $('#help-content').hide("slide", { direction: "right" }, "slow");
            $( "#help" ).text("Show Help");
      })

      {% if use_case.identifier == 'sale' %}
            $("#id_context_agent").change(getCustomers);
      {% endif %}


	}); // end document.ready

  function JsonSetUnitAndRule(resourceTypeId, targetId) {
	    if (targetId.search("usable") >= 0) {
		    direction = "use";
	    }
	    else {
		    direction = "other";
	    }
	    var prefix = targetId.split('-')[0];
	    var unitName = "#" + prefix + "-unit_of_quantity";
	    var jsonUrl = encodeURI("/accounting/json-directional-unit-and-rule/" + resourceTypeId + "/" + direction + "/");
	    $.get(jsonUrl,
		    function(data){
			    var unit = data["unit"];
                $(unitName).val(unit);
                var inventory_rule = data["rule"];
                //alert(inventory_rule);
                if (inventory_rule == "yes") {
                    //$('#div_id_unorderedreceipt-quantity').show();
                    //$('#div_id_unorderedreceipt-unit_of_quantity').show();
                    $('#div_id_unorderedreceipt-identifier').show();
                    $('#div_id_unorderedreceipt-url').show();
                    $('#div_id_unorderedreceipt-photo_url').show();
                    $('#div_id_unorderedreceipt-notes').show();
                    $('#div_id_unorderedreceipt-current_location').show();
                    $('#div_id_unorderedreceipt-access_rules').show();
                    $('.hideShow').show();
                } else {
                    //$('#div_id_unorderedreceipt-quantity').hide();
                    //$('#div_id_unorderedreceipt-unit_of_quantity').hide();
                    $('#div_id_unorderedreceipt-identifier').hide();
                    $('#div_id_unorderedreceipt-url').hide();
                    $('#div_id_unorderedreceipt-photo_url').hide();
                    $('#div_id_unorderedreceipt-notes').hide();
                    $('#div_id_unorderedreceipt-current_location').hide();
                    $('#div_id_unorderedreceipt-access_rules').hide();
                    $('.hideShow').hide();
                }
		    });
  };

  {% if use_case.identifier == 'sale' %}
    function getCustomers() {
        $(".chzn-select").trigger("liszt:updated");
        var selectedAgent = document.getElementById('id_context_agent').value;
        var jsonUrl = encodeURI("/accounting/json-context-agent-customers/" + selectedAgent + "/");
        var selectedCustomer = document.getElementById('id_customer').value;
        //var customerField =  $("#id_customer");
        $("#id_customer").empty();
        $.get(jsonUrl,
        function(data){
            $("#id_customer").append('<option value="">' + '--------' + '</option>');
            for(var i=0 ; i<data.length ; i++)
            {
                var id = data[i]['pk'];
                var name = data[i].fields['nick'];
                if (selectedCustomer == id) {
                    $("#id_customer").append('<option value="' + id + '" selected>' + name + '</option>');
                } else {
                    $("#id_customer").append('<option value="' + id + '">' + name + '</option>');
                }
            }
            $(".chzn-select").trigger("liszt:updated");
        });
    };
  {% endif %}

  </script>

{% endblock %}
